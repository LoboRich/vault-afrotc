
= form_for @loan do |f|
  - if @loan.errors.any?
    #error_explanation
      %h2= "#{pluralize(@loan.errors.count, "error")} prohibited this loan from being saved:"
      %ul
        - @loan.errors.full_messages.each do |message|
          %li= message
  .d-flex
    .col-md-6
      = f.label :client_id, :class => "form-label"
      = f.select :client_id, options_for_select(Client.all.order(:name).collect{ |u| [u.name, u.id]}), {required: true}, :class=>"form-control"
    .col-md-6
      = f.label :blocklot, :class => "form-label"
      = f.select :blocklot, options_for_select(@parcels), {}, { class: 'form-control js-example-tokenizer ', multiple: true }
  .d-flex
    .col-md-6
      = f.label :model_house, :class => "form-label"
      = f.text_field :model_house, class: 'form-control', required:  true
    .col-md-6
      = f.label :loan_financing, :class => "form-label"
      = f.text_field :loan_financing, class: 'form-control', required:  true
  .d-flex
    .col-md-6
      = f.label "terms in months", :class => "form-label"
      = f.number_field :terms, class: 'form-control', required:  true, onchange: "javascript: comp_month_amort()"
    .col-md-6
      = f.label :contract_price, :class => "form-label"
      = f.number_field :contract_price, class: 'form-control', required:  true, onchange: "javascript: comp_month_amort()"
  .d-flex
    .col-md-6
      = f.label :processing_fees, :class => "form-label"
      = f.number_field :processing_fees, class: 'form-control', required:  true, onchange: "javascript: comp_month_amort()"
    .col-md-6
      = f.label :downpayment, :class => "form-label"
      = f.number_field :downpayment, class: 'form-control', required:  true, onchange: "javascript: comp_month_amort()"
  .d-flex
    .col-md-6
      = f.label 'interest in %', :class => "form-label"
      = f.number_field :interest, class: 'form-control', required:  true, value: 18, readonly: true
    .col-md-6
      = f.label :balance, :class => "form-label"
      = f.number_field :balance, class: 'form-control', readonly:  true, onchange: "javascript: comp_month_amort()"
  .d-flex
    .col-md-6
      = f.label :monthly_amort, :class => "form-label"
      = f.number_field :monthly_amort, class: 'form-control', required:  true, readonly: true
    .col-md-6
      = f.label :contract_date, :class => "form-label"
      = f.date_field :contract_date, class: 'form-control', required:  true
  .d-flex
    .col-md-6
      = f.label :amortization_start_date, :class => "form-label"
      = f.date_field :amortization_start_date, class: 'form-control', required:  true      
    .col-md-6
      = f.label :broker, :class => "form-label"
      = f.text_field :broker, class: 'form-control'    
  .d-flex
    .col-md-6
      = f.label :remarks, :class => "form-label"
      = f.text_area :remarks, class: 'form-control'
  .mt-2
    = link_to 'Back', loans_path, class: 'btn btn-secondary'
    = f.submit 'Save Changes', class: 'btn btn-primary float-right'

:javascript
  $(document).ready(function(){
    $(".js-example-tokenizer").select2({
      tags: true,
      tokenSeparators: [',', ' ']
    });
    $('select').select2({
      createTag: function (params) {
        // Don't offset to create a tag if there is no @ symbol
        if (params.term.indexOf('@') === -1) {
          // Return null to disable tag creation
          return null;
        }

        return {
          id: params.term,
          text: params.term
        }
      }
    });
    $('select').select2({
      createTag: function (params) {
        var term = $.trim(params.term);

        if (term === '') {
          return null;
        }

        return {
          id: term,
          text: term,
          newTag: true // add additional parameters
        }
      }
    });
  });

  function comp_month_amort(){
    const balance = $("#loan_contract_price").val()-$("#loan_downpayment").val() - $("#loan_processing_fees").val()
    $.ajax({
      url: "/loans/compute_monthly_amort", // this will be routed
      type: 'GET',
      data: {
        balance: balance, 
        interest_rate: $("#loan_interest").val(),
        terms: $("#loan_terms").val()
      },
      async: true,
      dataType: "json",
      error: function(XMLHttpRequest, errorTextStatus, error){
          alert("Failed: "+ errorTextStatus+" ;"+error);
      },
      success: function(ret){
          $("#loan_balance").val(balance)
          $("#loan_monthly_amort").val(ret)
      }
    });
  }
  
      
