
.app.align-content-stretch.d-flex.flex-wrap
  .app-sidebar
    = render "layouts/sidebar"
  .app-container
    .app-content
      .content-wrapper
        .container
          .page-description.d-flex.align-items-center
            .page-description-content.flex-grow-1
              %h1= @loan.client.name
            .page-description-actions
              = link_to "/inhouse_loans/new?loan=#{@loan.id}", class: 'btn btn-primary' do
                %i.material-icons> add
                Create Inhouse Loan
          .row
            .card
              .card-body
                = form_for @loan do |f|
                  - if @loan.errors.any?
                    #error_explanation
                      %h2= "#{pluralize(@loan.errors.count, "error")} prohibited this loan from being saved:"
                      %ul
                        - @loan.errors.full_messages.each do |message|
                          %li= message
                  .row.m-t-sm
                    .col-md-4
                      = f.label :client, :class => "form-label"
                      = f.text_field :client, class: 'form-control', required:  true, disabled: true, value: @loan.client.name
                    .col-md-4
                      = f.label :blocklot, :class => "form-label"
                      - @loan.display_parcels.each do |info|
                        %p.form-control= info
                    .col-md-4
                      = f.label :model_house, :class => "form-label"
                      = f.text_field :model_house, class: 'form-control', required:  true, disabled: true
                  .row.m-t-sm
                    .col-md-4
                      = f.label :terms, :class => "form-label"
                      = f.number_field :terms, class: 'form-control', required:  true, disabled: true
                    .col-md-4
                      = f.label :loan_financing, :class => "form-label"
                      = f.text_field :loan_financing, class: 'form-control', required:  true, disabled: true
                    .col-md-4
                      = f.label :contract_price, :class => "form-label"
                      = f.text_field :contract_price, class: 'form-control', required:  true, disabled: true, value: format_currency_with_space(f.object.contract_price)
                  .row.m-t-sm
                    .col-md-4
                      = f.label :downpayment, :class => "form-label"
                      = f.text_field :downpayment, class: 'form-control', required:  true, disabled: true, value: format_currency_with_space(f.object.downpayment)
                    .col-md-4
                      = f.label :monthly_amort, :class => "form-label"
                      = f.text_field :monthly_amort, class: 'form-control', required:  true, disabled: true, value: format_currency_with_space(f.object.monthly_amort)
                    .col-md-4
                      = f.label :balance, :class => "form-label"
                      = f.text_field :balance, class: 'form-control', required:  true, disabled: true, value: format_currency_with_space(f.object.balance)
                  .row.m-t-sm
                    .col-md-4
                      = f.label :reservation_fee, :class => "form-label"
                      = f.text_field :reservation_fee, class: 'form-control', required:  true, disabled: true
                    .col-md-4
                      = f.label :contract_date, :class => "form-label"
                      = f.date_field :contract_date, class: 'form-control', required:  true, disabled: true
                    .col-md-4
                      = f.label :amortization_start_date, :class => "form-label"
                      = f.date_field :amortization_start_date, class: 'form-control', required:  true, disabled: true
                  .row.m-t-sm
                    
                    .col-md-4
                      = f.label :status, :class => "form-label"
                      = f.text_field :status, class: 'form-control', required:  true, disabled: true
                    .col-md-4
                      = f.label :broker, :class => "form-label"
                      = f.text_field :broker, class: 'form-control', required:  true, disabled: true
                    .col-md-4
                      = f.label :remarks, :class => "form-label"
                      = f.text_area :remarks, class: 'form-control', required:  true, disabled: true
                    
            .card
              .card-header  
                .page-description.d-flex.align-items-center
                  .page-description-content.flex-grow-1
                    %h1 Equity
                  .page-description-actions
                    = link_to pay_loan_path(@loan), class: 'btn btn-primary' do
                      %i.material-icons> add
                      Payment
              .card-body
                .table-responsive
                  %table#datatable1.display.dataTable{"aria-describedby" => "datatable1_info", :role => "grid", :style => "width: 100%;"}
                    %thead
                      %tr
                        %th #
                        %th Due Date
                        %th PMT. Date
                        %th OR
                        %th Amount
                        %th M.A
                        %th Balance
                        %th Status

                    %tbody
                      %tr
                        %td
                        %td
                        %td
                        %td
                        %td
                        %th
                        %td 
                          .text-primary.font-weight-s
                            = format_currency(@loan.downpayment - @loan.reservation_fee)
                        %td 
                      - total_monthly_amort = 0
                      - total_paid_amount = 0
                      - @loan.loan_items.order("duedate asc").each do |ai|
                        %tr
                          %td 
                            = ai.term
                          %td 
                            = ai.duedate.strftime("%b %d %Y")
                          %td
                            = ai.payment_date ? ai.payment_date.strftime("%b %d %Y") : ''
                          %td
                            = ai.or
                          %td
                            = number_to_currency(ai.paid_amount, unit: "₱ ", precision: 2, format: "%u%n")
                            - total_paid_amount += ai.paid_amount
                          %td
                            = number_to_currency(ai.monthly_amort, unit: "₱ ", precision: 2, format: "%u%n")           
                            - total_monthly_amort += ai.monthly_amort
                          %td
                            = number_to_currency(ai.balance, unit: "₱ ", precision: 2, format: "%u%n")
                          %td
                            .badges
                              - if ai.is_paid == true
                                <span class="badge bg-success">Paid</span>
                              - else
                                <span class="badge bg-info">Unpaid</span>
                      %tr
                        %td
                          %strong.hidden= @loan.loan_items.count+1
                        %td
                          Total
                        %td
                        %td
                        %td
                          = number_to_currency(total_paid_amount, unit: "₱ ", precision: 2, format: "%u%n")
                        %td
                          = number_to_currency(total_monthly_amort, unit: "₱ ", precision: 2, format: "%u%n")
                        %td
                        %td
                        

:javascript
  $(document).ready(function(){
    $('#datatable1_wrapper').DataTable();
    $(".js-example-tokenizer").select2({
      tags: true,
      tokenSeparators: [',', ' ']
    });
    $('select').select2({
      createTag: function (params) {
        // Don't offset to create a tag if there is no @ symbol
        if (params.term.indexOf('@') === -1) {
          // Return null to disable tag creation
          return null;
        }

        return {
          id: params.term,
          text: params.term
        }
      }
    });
    $('select').select2({
      createTag: function (params) {
        var term = $.trim(params.term);

        if (term === '') {
          return null;
        }

        return {
          id: term,
          text: term,
          newTag: true // add additional parameters
        }
      }
    });
  });